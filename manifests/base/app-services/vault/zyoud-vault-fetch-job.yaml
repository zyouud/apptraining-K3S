apiVersion: batch/v1
kind: Job
metadata:
  name: zyoud-vault-fetch
  namespace: zyoud
spec:
  backoffLimit: 1
  template:
    spec:
      serviceAccountName: zyoud-vault-fetch-sa
      restartPolicy: Never
      containers:
        - name: fetch
          image: alpine:3.19
          env:
            - name: VAULT_ADDR
              value: "http://zyoud-vault:8205"
            - name: VAULT_PATH
              value: "secret/data/zyoud-app"
            - name: K8S_NS
              value: "zyoud"
            - name: K8S_SECRET_NAME
              value: "zyoud-app-secrets"
            - name: VAULT_TOKEN
              valueFrom:
                secretKeyRef:
                  name: zyoud-vault-token
                  key: VAULT_TOKEN
          command: ["/bin/sh","-lc"]
          args:
            - |
              set -euo pipefail

              echo "[1/6] Install curl+jq..."
              apk add --no-cache curl jq >/dev/null

              echo "[2/6] Fetch from Vault: $VAULT_ADDR/v1/$VAULT_PATH"
              RAW="$(curl -sS -H "X-Vault-Token: $VAULT_TOKEN" "$VAULT_ADDR/v1/$VAULT_PATH")"
              KV="$(echo "$RAW" | jq -r '.data.data')"
              if [ "$KV" = "null" ] || [ -z "$KV" ]; then
                echo "ERROR: Vault returned no data. Full response:"
                echo "$RAW"
                exit 1
              fi

              echo "[3/6] Write .env file inside pod (/work/app.env)"
              mkdir -p /work
              echo "$KV" | jq -r 'to_entries|map("\(.key)=\(.value|tostring)")|.[]' > /work/app.env
              echo "----- .env keys -----"
              cut -d= -f1 /work/app.env | sort
              echo "---------------------"

              echo "[4/6] Prepare Kubernetes API access (in-cluster)"
              TOKEN="$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)"
              CACERT="/var/run/secrets/kubernetes.io/serviceaccount/ca.crt"
              API="https://kubernetes.default.svc"

              echo "[5/6] Delete existing secret if present"
              curl -sS --cacert "$CACERT" -H "Authorization: Bearer $TOKEN" \
                "$API/api/v1/namespaces/$K8S_NS/secrets/$K8S_SECRET_NAME" >/dev/null 2>&1 && \
              curl -sS --cacert "$CACERT" -H "Authorization: Bearer $TOKEN" \
                -X DELETE "$API/api/v1/namespaces/$K8S_NS/secrets/$K8S_SECRET_NAME" >/dev/null || true

              echo "[6/6] Create secret $K8S_SECRET_NAME using stringData"
              PAYLOAD="$(jq -n --arg name "$K8S_SECRET_NAME" --arg ns "$K8S_NS" --argjson kv "$KV" \
                '{apiVersion:"v1",kind:"Secret",metadata:{name:$name,namespace:$ns},type:"Opaque",stringData:$kv}')"

              curl -sS --cacert "$CACERT" \
                -H "Authorization: Bearer $TOKEN" \
                -H "Content-Type: application/json" \
                -X POST "$API/api/v1/namespaces/$K8S_NS/secrets" \
                -d "$PAYLOAD" >/dev/null

              echo "SUCCESS: Secret created."
