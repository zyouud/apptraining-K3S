name: deploy

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: read
  packages: write

env:
  NAMESPACE: zyoud
  FRONTEND_IMAGE: ghcr.io/zyouud/apptraining-frontend:latest
  BACKEND_IMAGE: ghcr.io/zyouud/apptraining-backend:latest

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ secrets.GHCR_USERNAME }}
          password: ${{ secrets.GHCR_TOKEN }}

      - name: Build & push backend
        run: |
          docker build -t "$BACKEND_IMAGE" ./backend
          docker push "$BACKEND_IMAGE"

      - name: Build & push frontend
        run: |
          docker build -t "$FRONTEND_IMAGE" ./frontend
          docker push "$FRONTEND_IMAGE"

      - name: Setup kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'v1.29.0'

      - name: Debug K3S_SERVER (must not be 127.0.0.1)
        run: |
          echo "K3S_SERVER=${K3S_SERVER}"
          if echo "${K3S_SERVER}" | grep -q "127.0.0.1"; then
            echo "ERROR: K3S_SERVER is 127.0.0.1. Set GitHub Secret K3S_SERVER to your public API server, e.g. https://37.27.31.43:6443"
            exit 1
          fi
        env:
          K3S_SERVER: ${{ secrets.K3S_SERVER }}

      - name: Configure kubeconfig (k3s) - NO SSH
        run: |
          mkdir -p ~/.kube
          cat > ~/.kube/config <<EOF
          apiVersion: v1
          kind: Config
          clusters:
          - name: k3s
            cluster:
              server: ${K3S_SERVER}
              certificate-authority-data: ${K3S_CA_CRT}
          contexts:
          - name: zyoud
            context:
              cluster: k3s
              namespace: ${NAMESPACE}
              user: zyoud-gha
          current-context: zyoud
          users:
          - name: zyoud-gha
            user:
              token: ${K3S_TOKEN}
          EOF

          # sanity check (namespace-scoped)
          kubectl -n ${NAMESPACE} get pods
        env:
          K3S_SERVER: ${{ secrets.K3S_SERVER }}
          K3S_TOKEN: ${{ secrets.K3S_TOKEN }}
          K3S_CA_CRT: ${{ secrets.K3S_CA_CRT }}

      - name: Apply Kubernetes manifests
        run: |
          # Apply order matters for some resources
          kubectl apply -f k8s/cert-manager/
          kubectl apply -f k8s/vault/
          kubectl apply -f k8s/postgres/
          kubectl apply -f k8s/backend/
          kubectl apply -f k8s/frontend/
          kubectl apply -f k8s/ingress/

      - name: Rollout restart deployments (zyoud namespace)
        run: |
          kubectl -n ${NAMESPACE} rollout restart deploy/zyoud-backend
          kubectl -n ${NAMESPACE} rollout restart deploy/zyoud-frontend

      - name: Rollout status
        run: |
          kubectl -n ${NAMESPACE} rollout status deploy/zyoud-backend --timeout=180s
          kubectl -n ${NAMESPACE} rollout status deploy/zyoud-frontend --timeout=180s
